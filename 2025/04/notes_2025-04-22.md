[Home](../../main.md) | [Prev: Day 130](notes_2025-04-21.md) | [Next: Day 132](./notes_2025-04-23.md)

## ğŸ“ Day 131, Tuesday - `notes_2025-04-22.md`

- US261 - create new TMP_SUMM_JAK2
    * uploaded `.html` jlab analysis results to devops board

- PreludeTx IT set up new AutoTask account, logged in with `arrayasolutions.com` user name

---

# ğŸ“Š Wide-to-Tall SQL Generator for Data Comparison

## ğŸ§­ Purpose

The goal of this script is to **convert a wide-format SQL table into a tall-format table** to facilitate easy comparison of multiple columns across **two tables** (`tmp_summ_jak2` and `summ_jak2`). This transformation allows for:

- Quick visual comparison of values between two sources
- Easier identification of mismatches and similarities
- Creation of a **sparse heatmap** that highlights data discrepancies

---

## ğŸ”¬ Technical Overview

### Input Tables

- **`tmp_summ_jak2`**: Temporary table (source: "tmp")
- **`summ_jak2`**: Main table (source: "main")

Both tables share the same schema with multiple columns, particularly grouped by **cell lines** (e.g., `SET2`, `TF1`) with common field patterns (like `IC50`, `HC`, `DMAX`, etc.).

### Cell Lines Processed

Only two cell lines are processed for clarity and performance:

- `SET2`
- `TF1`

Each has 15â€“18 associated fields (e.g., `CS_IC50_SET2`, `DMAX_TF1`, etc.).

### Transformation Logic

For each unique `formatted_id`:

1. A **CTE (Common Table Expression)** is created (e.g., `t1`, `t2`, ...).
2. Each CTE compares a matching pair of fields from `tmp` and `main`.
3. Each field pair becomes **two rows** in the output:
   - One for `tmp` (source: tmp)
   - One for `main` (source: main)

This forms a **"tall" table** with:
- `formatted_id` â†’ ID 
- Column name (e.g., `cs_ic50_set2`) â†’ MEASUREMENT
- Value (from tmp or main) â†’ VALUE
- Data origin â†’ `tmp` or `main` â†’ SOURCE

---

## ğŸ§± Output Structure

Each row in the tall table has:

| FORMATTED ID | MEASUREMENT  | SOURCE | VALUE       |
|------------------|-------------------|-------------|-------------|
| `PRT1011757`         | `cs_ic50_set2`    | `tmp`       | `0.05`      |
| `PRT1011757`         | `cs_ic50_set2`    | `main`      | `0.05`      |
| `PRT1011818`         | `dmax_tf1`        | `tmp`       | `1.20`      |
| `PRT1011818`         | `dmax_tf1`        | `main`      | `1.50`      |

---

## ğŸ§  Why Tall Format?

The **wide format** (default structure) has 212+ columns and is hard to scan manually, especially when trying to identify discrepancies:

```
| formatted_id | CS_IC50_SET2_tmp | CS_IC50_SET2_main | DMAX_SET2_tmp | DMAX_SET2_main | ...
|--------------|------------------|--------------------|----------------|------------------|
| PRT1011757 | 0.05             | 0.05               | 0.90           | 0.90             |
```

The **tall format** simplifies this into a **row-wise comparison** that can be easily visualized.

---

## ğŸ—ºï¸ Diagram: Wide to Tall Mapping

```text
[ WIDE TABLE ]                        [ TALL TABLE ]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ formatted_id â”‚ CS_IC50_SET2 â”‚ â”€â–¶â”€â”€â–¶ â”‚ MEASUREMENTâ”‚   SOURCE    â”‚   VALUE     â”‚
â”‚              â”‚ (tmp, main)   â”‚      â”‚ (formatted)â”‚ (col name)  â”‚ (value)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚ PRT1011796 â”‚ cs_ic50_set2â”‚     0.05    â”‚
                                     â”‚ PRT1011818 â”‚ cs_ic50_set2â”‚     0.05    â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ Output Summary

- The Python script uses a loop and templates to generate the SQL
- Removes manual SQL duplication and possible human error
- The final SQL query generated is ~12,000 lines long
- It includes around **120 CTEs**
- All logic is generated via Python to avoid manual duplication
---

## âš ï¸ Manual Trimming for Table Browser Compatibility

To make the query runnable:
- I manually **removed 3â€“5 CTEs** (roughly **40â€“50 lines**)
- This allowed the query to display specific subset of rows (PRT#'s) 
---

### ğŸ’¡ Table Browser Limitations

| Limitation            | Description                                                             |
|-----------------------|-------------------------------------------------------------------------|
| Max Display Rows      | Limited to **100 rows** total                                            |
| Visible at Once       | Only **~30 rows** are shown without scrolling                           |
| Scrolling Behavior    | Uses **lazy loading**, where additional rows load in **chunks of 30**   |
| No Code Pagination    | Canâ€™t jump to specific rows without scrolling manually                  |

---

### ğŸ§Š Simple Figure: Table Browser Behavior

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      TABLE BROWSER UI       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Row 1]                      â”‚
â”‚ [Row 2]                      â”‚
â”‚ [Row 3]                      â”‚
â”‚  ...                         â”‚
â”‚ [Row 30] â† visible initially â”‚
â”‚ â”€â”€â”€â”€â”€ Scroll down â”€â”€â”€â”€â”€â–¶     â”‚
â”‚ [Row 31]                     â”‚
â”‚ [Row 32]                     â”‚
â”‚  ...                         â”‚
â”‚ [Row 100] â† hard limit       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---
Due to these limitations:
- I perform local **script trimming** in order to copy and paste into a `.csv` file 
- It's a manual but necessary step since `DEV` environment didn't successfully compile the 12k lines of code but `PROD` did
- In `PROD` I was able to use `View Wizard` to simply export the Datasource as a `.csv` file

---

## ğŸ“‰ Heatmap Analysis (Post-Export)

Once the data is in CSV:

- Each row is a (formatted_id, column) pair
- A heatmap highlights:
  - **Exact matches** between `tmp` and `main`
  - **Discrepancies** via color variations
  - There are not differences in the PROD results and only differences in the DEV results due to #US256 changes
- Due to data sparsity, it's easy to visually identify missing or inconsistent values
- View two attached `.html` files for `PROD` and `DEV` results

---
