[Home](../../main.md) | [Prev: Day 202](notes_2025-08-01.md) | [Next: Day 204](./notes_2025-08-05.md)

## 📝 Day 203, Monday - `notes_2025-08-04.md`

### US341
- develop script to ingest tecan file and upload using mosaic api
    * generate mermaid code to draw diagram of workflow presented work done during meeting; mentioned issue with IDS data being incomplete 

```
flowchart TD
    A[Developer] -->|Writes Python code<br>initialized with Poetry| B[Poetry Project]
    B -->|Publish| C[ts-cli TetraScience CLI]
    C -->|Build and Push Container| D[AWS ECR]
    D -->|Container Available| E[TetraScience Platform]
    E -->|Select as Protocol| F[Pipeline Execution]

    F -->|Run Protocol| G[Python Script Execution]
    G -->|Query AWS Athena<br>for Experiment ID| H[Athena SQL Engine]
    H -->|Retrieve IDS Data| I[Python Script]

    I -->|Format Data into JSON| J[JSON Payload]
    J -->|POST Request| K[Mosaic API Server]
    K -->|Generate Labware IDs| L[Response with Labware IDs]

    L -->|Return IDs| M[Pipeline Continues]

    style B fill:#f0f8ff,stroke:#0077b6,stroke-width:2px
    style C fill:#f0f8ff,stroke:#0077b6,stroke-width:2px
    style D fill:#f0f8ff,stroke:#0077b6,stroke-width:2px
    style E fill:#f0f8ff,stroke:#0077b6,stroke-width:2px
    style F fill:#f0f8ff,stroke:#0077b6,stroke-width:2px
    style G fill:#e0f7e9,stroke:#00b894,stroke-width:2px
    style H fill:#e0f7e9,stroke:#00b894,stroke-width:2px
    style I fill:#e0f7e9,stroke:#00b894,stroke-width:2px
    style J fill:#ffeaa7,stroke:#fdcb6e,stroke-width:2px
    style K fill:#ffeaa7,stroke:#fdcb6e,stroke-width:2px
    style L fill:#ffeaa7,stroke:#fdcb6e,stroke-width:2px
    style M fill:#f8f9fa,stroke:#636e72,stroke-width:2px
```
- issue with `root` table not capturing the original file name, doesn't seem possible to distinguish duplicates with different file names
    * major flaw in the IDS Athena schema
    * `274507` exp id shows 5 rows (5 different data uploads; replicas when testing on TDP) 
        * `274507 2025-07-24 1326.csv`
        * `274507 2025-07-24 1325.csv`
        * `274507 2025-07-24 1324.csv`
        * `274507 2025-07-24 1323 - copy.csv`
        * `274507 2025-07-24 1323.csv`
    * and `207587` shows 2 (probably due to `207587.csv` and `wait 207587.csv`
    * if the protocol name is not unique, it would be virtually impossible to write logic in extracting most recent or specific data for a experiment id

```sql
  with parent_plates as (
    SELECT distinct parent_uuid
  FROM client_preludetx_tecan_parser_v1_plates
  WHERE experiment_id = '207587' -- 274507
  )
  select * from client_preludetx_tecan_parser_v1_root
  where uuid in (select * from parent_plates) 
```

- updated `main.py` in ssp-tecan-to-mosaic code for `get_exp_id_from_file()` to use file pointer dict and do a regex `.csv/0.json` match on file name

- found file path relation to possible distinguish replicate runs:

```sql
SELECT "file_id", "file_path", "org_slug", "trace_id", "file_key", "bucket", "version", "size", "checksum", "file_s3_content_encoding", "file_s3_content_type", "encoded_path", "raw_md5_checksum", "created_at", "category", "source_type", "source_name", "source_id", "input_pipeline_file_id", "ids", "ids_slug", "ids_version", "ids_namespace", "trace", "os_created_time", "os_last_modified_time", "os_size_on_disk", "partition_path", "record_created_at" FROM "file_info_v1" 
where file_key like '%274507%';

-- more re-fined version
SELECT * FROM "file_info_v1" where file_key like '%274507%'
and category = 'RAW' order by created_at desc;
;

-- the root table for tecan parse data
SELECT * FROM "client_preludetx_tecan_parser_v1_root" where experiment_protocol like '%274507%';

-- file_id of 0.json IDS of 205100
SELECT * FROM "file_info_v1" where file_id = 'd1cbcbbf-ffc7-4455-a74f-5516aa9aebe5';

-- parent_uuid from client_preludetx_plate_reader_parser_v1_root
SELECT "uuid", "parent_uuid", "reference", "result" FROM "client_preludetx_plate_reader_parser_v1_data" where parent_uuid = 'd1cbcbbf-ffc7-4455-a74f-5516aa9aebe5';
```

- issue for exp id 205100 is that the IDS data doesn't seem to exist on athena? can't find envision related data table
    * searched the workflow logs of `205100_01.csv`
    * shows:
        * Successfully get Tecan IDS file for experiment 205100 from Tetrascience Data Lake.
        * Successfully obtain tecan IDS file for experiment 205100
        * Successfully obtained token NAYLP-V6OPD-ZSLFQ-KZJSP-Z07YH
        * Error: Could not find the plate number: 1 in the Tecan file.
    * the issue remains where cannot distinguish replicate/duplicate `.csv` files for the exp id and its plates; no way to relate `client_preludetx_tecan_parser_v1_root` to `file_info_v1`

- steps from yaml, `client-preludetx / plate-reader-to-ids-to-dotmatics`

```yaml
steps:
  - id: getInfoFromLabels
    description: Fetch custom metadata object
    task:
      namespace: client-preludetx
      slug: hts-plate-reader-ids-to-dotmatics
      version: v1.0.0
      function: get-info-from-labels
    input:
      input_file_pointer: $( workflow.inputFile )
  - id: plateIdsPointer
    task:
      namespace: client-preludetx
      slug: parse-plate-reader
      version: v2.0.0
      function: parse-plate-reader
    input:
      input_file_pointer: $( workflow.inputFile )
      experiment_id: $( steps.getInfoFromLabels.output.experiment_id )
      plate_number: $( steps.getInfoFromLabels.output.plate_number )
  - id: assayPlatePointer
    task:
      namespace: common
      slug: dotmatics-util
      version: v2.3.0
      function: generate-assay-plate-template
    input:
      experiment_info: $( steps.plateIdsPointer.output )
      dotmatics_protocol_id: null
      dotmatics_username: $( config.dotmaticsUsername )
      dotmatics_password: $( config.dotmaticsPassword )
      dotmatics_hostname: $( config.dotmaticsHostname )
  - id: dotmaticsBodyPointer
    description: Generates request body for Dotmatics addPlates endpoint from
      Envision/Licor Plate Reader and Tecan data
    task:
      namespace: client-preludetx
      slug: hts-plate-reader-ids-to-dotmatics
      version: v1.1.0
      function: merge-envision-licor-tecan-to-dotmatics
    input:
      plate_ids_file_pointer: $( steps.plateIdsPointer.output )
      assay_plate_template_file_pointer: $( steps.assayPlatePointer.output )
      experiment_id: $( steps.getInfoFromLabels.output.experiment_id )
  - id: PushAssayPlateToDotmatics
    description: Push plate body to Dotmatics environment.
    task:
      namespace: common
      slug: dotmatics-util
      version: v2.3.0
      function: push-assay-plate-to-dotmatics
    input:
      dotmatics_body_pointer: $( steps.dotmaticsBodyPointer.output )
      dotmatics_username: $( config.dotmaticsUsername )
      dotmatics_password: $( config.dotmaticsPassword )
      dotmatics_hostname: $( config.dotmaticsHostname )
      create_new_experiment: false
      label_file_as_pushed: true
      pointer_to_label_target: $( workflow.inputFile )
```


### US344
- investigate edge cases where a Assay Data table and Summary do not match
    * confirmed on DEV that IC50 value now shows the real number and not the non-real number
    * issue with N count since it shouldn't count the non-real number
    * added `WHERE` clause where `COMPOUND_STATUS IS NULL` to fix N count issue
