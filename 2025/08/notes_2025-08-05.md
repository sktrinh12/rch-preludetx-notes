[Home](../../main.md) | [Prev: Day 203](notes_2025-08-04.md) | [Next: Day 205](./notes_2025-08-06.md)

## üìù Day 204, Tuesday - `notes_2025-08-05.md`

### US344
- investigate edge cases where a Assay Data table and Summary do not match
    * updated sql for `SUMM_JAK2`, `SUBQ_SUMM_JAK2` and `T1_T2_SUMM_JAK2` for PROD
    * these changes are only for `ic50_nm_jh2_v617f_prt`

### US341
- develop script to ingest tecan file and upload using mosaic api
    * searched for exp id on TS, `209103`, on TDP it seems to exist from Tecan RAW to IDS pipeline, however when searching on Mosaic, it returned empty array

#### Initial PyAthena Error

**Issue:**

```
TypeError: sequence item 0: expected str instance, dict found
```

**Cause:**
Due to incorrect aws secret keys since need to pass str not dict, the dict object was the `input` value, and need `context.resolve_secret()` to convert to str

**Resolution:**
use of the `context.resolve_secret()`. Documentation was very limited, example does not show how to use `secret` strings; had to dig deep and encountered an example in the Community Hub website


---

#### `httpx` HTTP/2 Dependency Error

**Issue:**

```
‚ùå Error: Using http2=True, but the 'h2' package is not installed.
```

**Cause:**
`httpx` with `http2=True` requires the `h2` dependency, which is not included by default.

**Resolution:**
Updated `requirements.txt`:

```txt
httpx[http2]>=0.28.1
```

Re-exported dependencies using:

```bash
poetry export --without-hashes --format=requirements.txt > requirements.txt
```

---

#### Ensuring Dependencies in TetraScience ECR Container

**Action Taken:**
Followed TetraScience packaging instructions:

1. Initialized package with Poetry:

   ```bash
   poetry init
   ```
2. Added dependencies:

   ```bash
   poetry add httpx[http2] pyathena
   ```
3. Exported the requirements:

   ```bash
   poetry export --without-hashes --format=requirements.txt > requirements.txt
   ```
4. Published task script:

   ```bash
   ts-cli publish --type task-script --namespace private-{TDP ORG} --slug tecan-to-mosaic --version vX.X.X {task-script-folder} -c {auth-folder}/auth.json
   ```

---

#### Fixing `raise_for_status()` Behavior

**Issue:**
`response.raise_for_status()` raised exceptions before reaching `else` blocks, preventing custom error handling.

**Resolution:**
Refactored logic to only call `raise_for_status()` after logging errors:

```python
if response.status_code == 201:
    ...
else:
    print(f"‚ùå Failed to upload ...")
    response.raise_for_status()
```

Same adjustment applied to the solvent API call (`204` check).

#### Duplication of wells in payload 

**Issue:**
the `substance_payload` (JSON payload that defines each wells) was being duplicated and the Mosaic API was rejecting the `POST` http request

**Resolution:**
No real resolution, however tried to use a different exp id that does not have duplicate data, the issue is that Athena (Tecan IDS) is not storing file name metadata to distinguish duplicate uploads or updated uploads; and the SQL is querying all the data related to that exp id. Tried to copy an older file, `247507` and change the exp id in the content of file as well as the file name and `Tecan RAW to IDS` worked fine and can query inside of Tetrascience UI, however the cli and python code showed 0 results
