[Home](../../main.md) | [Prev: Day 205](notes_2025-08-06.md) | [Next: Day 207](./notes_2025-08-08.md)

## 📝 Day 206, Thursday - `notes_2025-08-07.md`

### US341
- develop script to ingest tecan file and upload using mosaic api
    * discovered that the `$path` column can be queried in athena that ties the original file path
    * `$path` is a pseudo-column that returns the S3 file path from which each row of data was read
    * It only works when querying partitioned or external tables backed by S3
    * It’s not listed in the Glue schema or table DDL — but Athena exposes it automatically
    * `$path` is only available in Athena (not in Glue, Redshift, Tetrascience or other SQL engines)
    * **Source:** [https://repost.aws/knowledge-center/find-s3-source-file-athena-table-row](https://repost.aws/knowledge-center/find-s3-source-file-athena-table-row)


```sql
SELECT "$path", *
FROM client_preludetx_tecan_parser_v1_plates
where experiment_id = '999101'


-- updated main sql
WITH plate_files AS (
  SELECT parent_uuid,
     regexp_extract(
        regexp_extract("$path", '[^/]+$'), 
            '([^__]+\.csv)(?=__|$)'
     ) AS file_name
  FROM client_preludetx_tecan_parser_v1_plates
  WHERE experiment_id = %(exp_id)s
),
plate_parent AS (
  SELECT parent_uuid
  FROM plate_files
  WHERE file_name = %(file_name)s
  LIMIT 1
),
```

- add set of solvent names to ensure payload distinguishes properly; query_line_limit set to 38 at the main select query, logic to include name colm in `build_sample_holder()`; init labware_item_id to None; logic to ensure labware_item_id is valid for solvent dispense
- increment version to 0.1.9 for protocol and pyproject
- volume_dispensed_value is the column name and defined as volume_value which should be divided by 1000 if unit is nL, remove fall back to 0 since the sql already ensures it is not null for `main.py`
- include quote function to url encode the file_name for `main.py`
- remove raise error that was used just for testing athena query for `query-athena.py` (local testing version)
- the latest bug/error issue was calling the `patch` api to update a labware item with the substance_payload, however did not pursue development for this logic because it probably won't ever be the case where there are some substances from an experiment id that differed from a previous submission for the update api call
    * this means that the update didn't work because of some wells that have valid substances couldn't be updated due to a non-existing substance in the new `update` payload
    * even if it is some logic that needs to be pursued down the road, it won't be now, can return later if need be, it only errors when there is existing labware item id
- tried a new exp id: `210347`, but there are some oddly named rows, and other PRT#'s didn't exist in MOSAIC UAT server:

```json
{"formattedName": {"name": "PRT1008610-001" }},
{"formattedName": {"name": "PRT1008593-001" }},
{"formattedName": {"name": "PRT1008391-001" }},
{"formattedName": {"name": "PRT8392 with 4uM PRT8610" }},
{"formattedName": {"name": "PRT8392 with 4uM PRT6846" }},
{"formattedName": {"name": "PRT1006966-001" }},
{"formattedName": {"name": "PRT1008716-001" }},
{"formattedName": {"name": "PRT1008715-001" }},
{"formattedName": {"name": "PRT1008393-001" }},
{"formattedName": {"name": "PRT1007561-001" }},
{"formattedName": {"name": "PRT1008594-001" }},
{"formattedName": {"name": "PRT1008717-001" }},
{"formattedName": {"name": "PRT1008392-001" }},
{"formattedName": {"name": "PRT1006846-001" }},
{"formattedName": {"name": "PRT1008445-001" }},
{"formattedName": {"name": "PRT1008447-001" }},
{"formattedName": {"name": "PRT1008714-001" }},
```

- ran quick terminal command to convert file_name into uri encoded: `jq -nr --arg str "210367 2023-05-11 1054.csv" '$str | @uri' | xclip -selection clipboard`
    * pasted the 2 exp_id and the output of above command for file_name
    * appended, `select distinct name from t` to the main script query to get list of the PRT#s
    * exp_id: `210368` has existing substances on MOSAIC UAT (`https://{mosaic-server-dev}.mosaic-cloud.com/api/inventory/Substances/Lookup?expand=substances`)
    * double checked if all substances exist and are valid using Mosaic `/Substances/Lookup` api
    * on preludeix02 server (neuron); logged into TS platform and searched for the `210367 2023-05-11 1054.csv` file to download
    * renamed it `999103 2023-05-11 1024.csv` and also replaced all `210367` -> `999103`

```json
{"formattedName": {"name": "PRT1006914-001" }},
{"formattedName": {"name": "PRT1007111-001" }},
{"formattedName": {"name": "PRT1007066-001" }},
{"formattedName": {"name": "PRT1007105-001" }},
{"formattedName": {"name": "PRT1000816-001" }},
{"formattedName": {"name": "PRT1007109-001" }},
{"formattedName": {"name": "PRT1006957-001" }},
{"formattedName": {"name": "PRT1006845-001" }},
{"formattedName": {"name": "PRT1008511-001" }},
{"formattedName": {"name": "PRT1007104-001" }},
{"formattedName": {"name": "PRT1007108-001" }},
{"formattedName": {"name": "PRT1007025-001" }},
{"formattedName": {"name": "PRT1007021-001" }},
{"formattedName": {"name": "PRT1007057-001" }},
{"formattedName": {"name": "PRT1007063-001" }},
{"formattedName": {"name": "PRT1007064-001" }},
{"formattedName": {"name": "PRT1007067-001" }}
```
