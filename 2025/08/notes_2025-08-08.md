[Home](../../main.md) | [Prev: Day 206](notes_2025-08-07.md) | [Next: Day 208](./notes_2025-08-11.md)

## üìù Day 207, Friday - `notes_2025-08-08.md`

### US341
- develop script to ingest tecan file and upload using mosaic api
    * the latest bug/error issue was calling the `patch` api to update a labware item with the substance_payload, specifically for `209103` or `209103%202025-08-05.csv` on TS 
    * `Error: Client error '400 Bad Request' for url 'https://prelude-test.mosaic-cloud.com/api/Inventory/LabwareItems/87020' For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/400`
    * the reasoning to not continue development to address this error is because the original first run for `209103` possibly had different data, and subsequent runs thus did not match the wells that were on mosaic server, thus the `patch` request failed since the api probably requires the sampleHolders to be identical
    * `"code": "InvalidRequest", "message": "Sample holder is empty. Use 'Set Solution Sample' endpoint."`

---

#### Troubleshooting patch HTTP request error

- Compare the `sampleHolders` positions from the Mosaic server **GET** response against the **PATCH** update payload to identify any discrepancies.

#### 1. Extract `x,y` Positions from PATCH Payload

Used `jq` to pull all `sampleHolders` positions as a simple list in the form `x,y` for easy comparison:

```bash
jq -r '.sampleHolders[] | "\(.position.x),\(.position.y)"' update_payload.json > update_positions.txt
```

#### 2. Extract `x,y` Positions from GET Payload

Because the GET payload structure differs, extracted positions accordingly:

```bash
jq -r '.[].sampleHolders[] | "\(.sampleHolderIdentifier.position.x),\(.sampleHolderIdentifier.position.y)"' server_get.json > server_positions.txt
```

#### 3. Sort Position Lists

Sorted both position files to prepare for line-by-line comparison:

```bash
sort server_positions.txt -o server_positions.txt
sort update_positions.txt -o update_positions.txt
```

#### 4. Compare Positions Using `comm`

Used the `comm` tool to find positions present in the GET payload but missing in the PATCH update:

```bash
comm -23 server_positions.txt update_positions.txt > missing_in_patch.txt
```

#### 5. Analyze Results

* The output lists all `(x,y)` positions present on the server but not included in the update payload.
* Confirmed that the update payload is missing certain wells compared to the server GET data.

- Results of `comm -23` command:
    * this means all of these well positions exist in the server side for `209103` but don't exist in the update payload; leading me to think the original `209103` data was actually from a different exp id; and thus don't match

```
10,1
10,15
10,16
1,1
1,10
1,11
11,1
11,15
11,16
1,12
1,13
1,14
1,15
1,16
1,2
12,1
12,10
12,11
12,12
12,13
12,14
12,15
12,16
12,2
12,3
12,4
12,5
12,6
12,7
12,8
12,9
1,3
13,1
13,10
13,11
13,12
13,13
13,14
13,15
13,16
13,2
13,3
13,4
13,5
13,6
13,7
13,8
13,9
1,4
14,1
14,10
14,16
1,5
15,1
15,10
15,16
1,6
16,1
16,10
16,16
1,7
17,1
17,10
17,16
1,8
18,1
18,10
18,16
1,9
19,1
19,10
19,16
20,1
20,10
20,16
2,1
21,1
21,10
21,16
2,16
22,1
22,10
22,16
23,1
23,16
24,1
24,10
24,11
24,12
24,13
24,14
24,15
24,16
24,2
24,3
24,4
24,5
24,6
24,7
24,8
24,9
3,1
3,15
3,16
4,1
4,15
4,16
5,1
5,15
5,16
6,1
6,15
6,16
7,1
7,15
7,16
8,1
8,15
8,16
9,1
9,15
9,16
```

* copied the file content of 209103 and re-named it 999104; and ran the pipeline again
* indeed re-running it completed successfully:
* it detected that it already existed and emptied the labware then patched it

```
Creating labware items üßæ 999104_01...
‚ö†Ô∏è Labware 999104_01 already exists. Fetching labware ID...
‚úÖ Updated existing labware 87039 on prelude-test.mosaic-cloud.com/api
```

* test sql to show file_name, time_start, experiment_protocol

```sql
WITH plate_files AS (
  SELECT distinct parent_uuid,
     regexp_extract(
        regexp_extract("$path", '[^/]+$'), 
        '([^__]+\.csv)(?=__|$)'
     ) AS file_name
  FROM client_preludetx_tecan_parser_v1_plates
  WHERE experiment_id = '999104'
)
  SELECT 
    pf.parent_uuid,
    pf.file_name,
    r.time_start,
    r.experiment_protocol
  FROM plate_files pf
  JOIN "client_preludetx_tecan_parser_v1_root" r ON pf.parent_uuid = r.uuid
  WHERE 
    pf.file_name LIKE '999104%2025-08-05.csv'
  ORDER BY r.time_start DESC 
```


#### Install odbc driver for athena 

- [tetrascience-ref-link](https://tetrascience.zendesk.com/hc/en-us/articles/27019394352525-Amazon-Athena-ODBC-Driver-Configuration-and-SQL-Query-Test) 
- [aws-ref-link](https://docs.aws.amazon.com/athena/latest/ug/connect-with-odbc.html)


1. Installed unixODBC from source

- Downloaded unixODBC 2.3.12 tarball from: [https://www.unixodbc.org/unixODBC-2.3.12.tar.gz](https://www.unixodbc.org/unixODBC-2.3.12.tar.gz)

- Extracted, configured, built, and installed it manually:
```bash
tar -xzf unixODBC-2.3.12.tar.gz
cd unixODBC-2.3.12
./configure --prefix=/usr/local
make
sudo make install
````

* This installed unixODBC binaries and libraries to `/usr/local`

2. Installed Amazon Athena ODBC Driver

* Downloaded the Amazon Athena ODBC driver RPM from AWS:


3. Configured ODBC driver (`odbcinst.ini`)

* Created or edited `/usr/local/etc/odbcinst.ini` to add:

  ```ini
  [Amazon Athena ODBC (x64)]
  Driver=/opt/athena/odbc/lib/libathena-odbc.so
  Setup=/opt/athena/odbc/lib/libathena-odbc.so
  ```

4. Configured ODBC data source name (DSN) (`odbc.ini`)

* Created or edited `/opt/athena/odbc/ini/odbc.ini` with:

  ```ini
  [ODBC Data Sources]
  preludetx_uat=Amazon Athena ODBC (x64)

  [preludetx_uat]
  Description=Amazon Athena ODBC (x64)
  Driver=Amazon Athena ODBC (x64)
  AwsRegion=us-east-1
  Workgroup=preludetx-uat
  Catalog=AWSDataCatalog
  Schema=preludetx_uat
  AuthenticationType=IAM Credentials
  UID=aws_access_key
  PWD=aws_secret_key
  S3OutputLocation=s3://bucket-path/
  UseSingleCatalogAndSchema=1
  ```

5. Exported environment variables to point unixODBC to config files

```bash
export ODBCINI=/opt/athena/odbc/ini/odbc.ini
export ODBCSYSINI=/opt/athena/odbc/ini/
```

6. Check file pointers `odbcinst -j`

```bash
unixODBC 2.3.12
DRIVERS............: /opt/athena/odbc/ini//odbcinst.ini
SYSTEM DATA SOURCES: /opt/athena/odbc/ini//odbc.ini
FILE DATA SOURCES..: /opt/athena/odbc/ini//ODBCDataSources
USER DATA SOURCES..: /opt/athena/odbc/ini/odbc.ini
SQLULEN Size.......: 8
SQLLEN Size........: 8
SQLSETPOSIROW Size.: 8
```


7. Tested connection using `isql`

```bash
isql -v preludetx_uat
```


8. Quit or exit

```bash
Ctrl + C
Ctrl + D
```
