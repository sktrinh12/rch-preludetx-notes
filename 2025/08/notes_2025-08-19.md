[Home](../../main.md) | [Prev: Day 213](notes_2025-08-18.md) | [Next: Day 215](./notes_2025-08-20.md)

## üìù Day 214, Tuesday - `notes_2025-08-19.md`

### US341
- develop script to ingest tecan file and upload using mosaic api
    * test on UAT
    * created new file, `strinh_2025_08_18_12_30.txt` and ran the post tecan ids to mosaic pipeline
    * showed successful pipeline run; may want to test with more barcodes (plat ids); request from preludetx for more testing barcodes
    * the `protocol.yml` file in task-script works as follows, where input of second step is output of first step
    * also need to update the `config.json` to include both functions

```yaml
steps:
  - id: validate-barcodes
    task:
      namespace: private-preludetx-uat
      slug: tecan-to-mosaic
      version: v0.2.1
      function: validate-barcodes
    input:
      input_file_pointer: $( workflow.inputFile )
  - id: post-ids-to-mosaic
    task:
      namespace: private-preludetx-uat
      slug: tecan-to-mosaic
      version: v0.2.1
      function: create-mosaic-labware
    input:
      input_content: $( steps["validate-barcodes"].output )
      mosaic_api_password: $( config["mosaic-api-password-secret-name"] )
```

```json
    "functions": [
        {
            "slug": "validate-barcodes",
            "function": "main.validate_barcodes"
        },
        {
            "slug": "create-mosaic-labware",
            "function": "main.create_mosaic_labware"
        }
    ]
```

- added `context.` metadata to comment for mosaic upload:

```python
    "comment": (
        f"Created labware from Tetrascience - API call | "
        f"file_name={file_name}, "
        f"master_script_slug={context.master_script_slug}, "
        f"master_script_version={context.master_script_version}, "
        f"protocol_slug={context.protocol_slug}, "
        f"protocol_version={context.protocol_version}, "
        f"task_created_at={context.task_created_at}, "
        f"platform_url={context.platform_url}, "
        f"platform_version={context.platform_version}"
    ),
```

### US339
- add delayed-testing to any work items that have higher than 20 day turn-around time
    * ensured the query is most up-to-date since the query is manual, specifying list of ID's

#### 1: WIQL Query to get Closed Work Items with relevant dates

```bash
read -r -d '' WIQL_QUERY << EOM
{
  "query": "
    SELECT
      [System.Id],
      [System.CreatedDate],
      [Microsoft.VSTS.Common.ClosedDate]
    FROM WorkItems
    WHERE
      [System.TeamProject] = 'PreludeTx_Dotmatics_2024' AND
      [System.State] = 'Closed'
    ORDER BY [System.ChangedDate] DESC
  "
}
EOM
```

#### 2: Using curl to execute WIQL and store response

```bash
API_URL="https://dev.azure.com/preludetx/PreludeTx_Dotmatics_2024/_apis/wit/wiql?api-version=7.0"
WIQL_RESPONSE=$(curl -s -u ":$AZURE_DEVOPS_PAT" \
  -H "Content-Type: application/json" \
  -X POST \
  -d "$WIQL_QUERY" \
  "$API_URL")
```

#### 3: Extract Work Item IDs from WIQL response

```bash
IDS=$(echo "$WIQL_RESPONSE" | jq -r '.workItems[].id' | paste -sd,)
```

#### 4: Chunk `IDS` to satisfy 200 item limit on API call 

```bash
# Convert comma-separated IDS into array
IDS_ARRAY=(${(s:,:)IDS})

# Split into two chunks (first 115, second rest)
CHUNK1=(${IDS_ARRAY[1,115]})
CHUNK2=(${IDS_ARRAY[116,-1]})
```


#### 5: Fetch detailed work item data in chunks

```bash
ORG="https://dev.azure.com/preludetx/PreludeTx_Dotmatics_2024"
WORK_ITEM_1=$(curl -s -u ":$AZURE_DEVOPS_PAT" \
  -H "Content-Type: application/json" \
  "$ORG/_apis/wit/workitems?ids=$(IFS=,; echo "${CHUNK1[*]}")&fields=System.Id,System.CreatedDate,Microsoft.VSTS.Common.ClosedDate")

WORK_ITEM_2=$(curl -s -u ":$AZURE_DEVOPS_PAT" \
  -H "Content-Type: application/json" \
  "$ORG/_apis/wit/workitems?ids=$(IFS=,; echo "${CHUNK2[*]}")&fields=System.Id,System.CreatedDate,Microsoft.VSTS.Common.ClosedDate")
```

#### 6: Filter work items where completion time > 20 days using `jq`

- Use of `sub("\\.[0-9]+Z$"; "Z")`
    * Azure DevOps returns timestamps with fractional seconds, e.g. 2024-07-16T11:05:13.68Z which fromdateiso8601 cannot parse.
    * This strips the fractional seconds to make the date parseable by `jq`
    * The difference is calculated in seconds: `60 * 60 * 24 * 20 =` number of seconds in 20 days

```bash
echo "$WORK_ITEM_1" | jq -r '
  .value[] |
  select(
    ((.fields["Microsoft.VSTS.Common.ClosedDate"] | sub("\\.[0-9]+Z$"; "Z")) | fromdateiso8601) -
    ((.fields["System.CreatedDate"] | sub("\\.[0-9]+Z$"; "Z")) | fromdateiso8601) > (60*60*24*20)
  ) | .id
'
```

### Add TS/DTX tags to all relevant devops work items
* manually added each one for first 100+
* manually added groups from a query using `does not contain string`

### US356
- assist with tetrascience pherastar pipeline processing on UAT
    * `268783_01.csv` file copied and pasted in the `/pherastar_uat` on shared drive and ensured the triggers were correct: 
    * the file path was wrong in trigger `/pherastar_gen2`
    * the instrument_model was incorrect, set to `Pherastar` and not `Pherastar FSX`
    * successfully triggered `Decorate RAW PheraStar data` pipeline and `BMG Labtech Pherastar RAW to IDS`
    * however was pending on the second pipeline for over 11 minutes; still awaiting results
    * it error-ed probably due to input file issue:

```
The source data is missing these expected sections: {'Layout', 'Measurement Data', 'Kinetic Windows', 'Basic Parameters', 'Concentrations/Injections/Shaking', 'Used Versions/Reader, User Name'}
```
