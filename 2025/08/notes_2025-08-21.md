[Home](../../main.md) | [Prev: Day 215](notes_2025-08-20.md) | [Next: Day 217](./notes_2025-08-22.md)

## 📝 Day 216, Thursday - `notes_2025-08-21.md`

### US352
- New ADC Project planning
    * testing on DEV for 'hiding' CAL-R data from `ADC_TARGET_VW` when user is not authorised
    * the group name itself (“Temp – Testing”) is encoded in the `ISID` column of `GATEWAY.PERSONNEL_ROLES`, with an @ prefix to distinguish it from users or projects: ISID = '@Temp - Testing' OBJECTNAME = 'GROUP' GROUP_ID = 481
    * That means there isn’t a separate lookup table like `BROWSER_GROUPS` — instead, the system is denormalized, and group metadata is embedded directly in `PERSONNEL_ROLES`
    * the `WHERE` logic using `EXISTS` and `OR` goes like this: 
        * Normally, rows with ab_target = 'CAL-R' would be excluded. But if the user is in group 481 (the EXISTS is true), then all rows pass, including 'CAL-R'.


```sql
select * from ADC_TARGET_VW
where ab_target = 'CAL-R'
;


-- show isid in relation to components/modules
SELECT
    a.isid,
    a.role,
    c.component
  FROM ds3_appdata.role_master a
  JOIN ds3_appdata.component_enum c ON a.component= c.ordinal
  WHERE a.isid like 'PRE%'
;


-- main query to get isid users in a group
-- 481 is the `Temp - Testing` group in User Admin -> Group
select isid, objectname, role_id, valuename, group_id from GATEWAY.PERSONNEL_ROLES
where group_id = 481
;

-- ADC_TARGET_VW (ORIGINAL)
SELECT
    to_date(to_char(e.date_created, 'MM-DD-YYYY'), 'MM-DD-YYYY') AS registeration_date,
    a.bioreg_id AS parent_bioreg_id,
    b.bioreg_id,
    'PRT500'||substr(b.bioreg_id, 7, 4) AS formatted_tr,
    c.value AS ab_target,
    d.value AS payload_target
  FROM
    (SELECT
       b.date_created,
       b.id,
       b.bioreg_id,
       a.child_id
     FROM c2c.complex_child a
     JOIN c2c.complex b ON b.id=a.complex_id) a
  JOIN
    (SELECT *
     FROM c2c.complex_child a
     JOIN c2c.complex b ON b.id=a.child_id
     WHERE upper(composition) not like '%DELETED%') b ON b.child_id=a.child_id
  LEFT JOIN
    (SELECT
       a.id,
       a.name,
       b.value,
       b.owner_id
     FROM c2c.string_value_type a
     JOIN c2c.string_value b ON a.id=b.type_id
     WHERE b.type_id =6) c ON a.id=c.owner_id
  LEFT JOIN
    (SELECT
       a.id,
       a.name,
       b.value,
       b.owner_id
     FROM c2c.string_value_type a
     JOIN c2c.string_value b ON a.id=b.type_id
     WHERE b.type_id =16) d ON a.child_id=d.owner_id
  LEFT JOIN
    (SELECT *
     FROM c2c.complex_) e ON b.bioreg_id=e.bioreg_id
;


-- more granularity with CAL-R exclusion
-- use of CTE
WITH base_query AS (
    SELECT
        TO_DATE(TO_CHAR(e.date_created, 'MM-DD-YYYY'), 'MM-DD-YYYY') AS registration_date,
        a.bioreg_id AS parent_bioreg_id,
        b.bioreg_id,
        'PRT500' || SUBSTR(b.bioreg_id, 7, 4) AS formatted_tr,
        c.value AS ab_target,
        d.value AS payload_target
    FROM (
        SELECT b.date_created, b.id, b.bioreg_id, a.child_id
        FROM c2c.complex_child a
        JOIN c2c.complex b ON b.id = a.complex_id
    ) a
    JOIN (
        SELECT *
        FROM c2c.complex_child a
        JOIN c2c.complex b ON b.id = a.child_id
        WHERE UPPER(composition) NOT LIKE '%DELETED%'
    ) b ON b.child_id = a.child_id
    LEFT JOIN (
        SELECT a.id, a.name, b.value, b.owner_id
        FROM c2c.string_value_type a
        JOIN c2c.string_value b ON a.id = b.type_id
        WHERE b.type_id = 6
    ) c ON a.id = c.owner_id
    LEFT JOIN (
        SELECT a.id, a.name, b.value, b.owner_id
        FROM c2c.string_value_type a
        JOIN c2c.string_value b ON a.id = b.type_id
        WHERE b.type_id = 16
    ) d ON a.child_id = d.owner_id
    LEFT JOIN (
        SELECT * FROM c2c.complex_
    ) e ON b.bioreg_id = e.bioreg_id
)
SELECT *
FROM base_query q
WHERE (
    q.ab_target <> 'CAL-R'
    OR EXISTS (
        SELECT 1
        FROM GATEWAY.PERSONNEL_ROLES pr
        WHERE pr.group_id = 481
          AND pr.isid = UPPER('-USER-')
    )
)
;


-- get the bioreg_ids that have CAL-R ab-targets
SELECT DISTINCT child.bioreg_id
FROM c2c.complex_child cc
JOIN c2c.complex parent ON parent.id = cc.complex_id
JOIN c2c.complex child ON child.id = cc.child_id
JOIN c2c.string_value sv ON sv.owner_id = parent.id
JOIN c2c.string_value_type svt ON svt.id = sv.type_id
WHERE svt.id = 6
  AND sv.value = 'CAL-R'
;


-- filter based on ADC_REG_INFO
WITH t AS (
    SELECT DISTINCT child.bioreg_id
    FROM c2c.complex_child cc
    JOIN c2c.complex parent ON parent.id = cc.complex_id
    JOIN c2c.complex child ON child.id = cc.child_id
    JOIN c2c.string_value sv ON sv.owner_id = parent.id
    JOIN c2c.string_value_type svt ON svt.id = sv.type_id
    WHERE svt.id = 6
      AND sv.value = 'CAL-R'
)
SELECT *
FROM ADC_REG_INFO adc
WHERE bioreg_id NOT IN (SELECT bioreg_id FROM t)
   OR EXISTS (
       SELECT 1
       FROM GATEWAY.PERSONNEL_ROLES pr
       WHERE pr.group_id = 481
         AND pr.isid = UPPER('-USER-')
   )
```


### US341
- develop script to ingest tecan file and upload using mosaic api
    * Genaro is creating tecan files from scratch (copy+pasting) and created 3 exp ids: 4 plates per experiment, Study `268805`, `268806`, `268807`
    * ran into issue with Tecan Raw to IDS pipeline: 

```
V: Reading Tecan file...

V: Converting Tecan file to JSON...

Error: Reached out end of file.

```

- Issue was during copy+paste, file was mysteriously truncated whilst working on the preludex02 server:
>I saw the file size originally was around 6 MB and now it is 1

* checked barcodes to validate if they exist on UAT TDP
* 12 plates were produced from tecan files and uploaded in one go
* the data exists on TDP and ready to test using the `.txt` trigger file

```sql
SELECT "uuid", "parent_uuid", "pk", "name", "experiment_id", "id", "type", "rows", "columns", "additional_volume_value", "additional_volume_unit", "dmso_limit_value", "dmso_limit_unit", "donnot_shake", "donnot_dispense" FROM "client_preludetx_tecan_parser_v1_plates" where name in (
    '268805_01',
    '268805_02',
    '268805_03',
    '268805_04',
    '268806_01',
    '268807_01',
    '268806_02',
    '268807_02',
    '268806_03',
    '268807_03',
    '268806_04',
    '268807_04'
)
```

- made changes to tecan-to-mosaic pipeline:
    * `diff --git a/tetrascience/ssp-tecan-to-mosaic/task-script/main.py b/tetrascience/ssp-tecan-to-mosaic/task-script/main.py`
    * got artifact error from AWS ECR, not sure why it started now, and didn't occur before, perhaps TS made backend changes and now catching these errors
    * downgraded the tenacy version and `ts-cli publish` command worked
    * also changed the truncate payload number of lines to half since the test `.txt` file will contain 12 barcodes

```diff
index 23d78dd..0a34e05 100644
--- a/tetrascience/ssp-tecan-to-mosaic/task-script/main.py
+++ b/tetrascience/ssp-tecan-to-mosaic/task-script/main.py
-payload_line_limit = 250  # number of lines to truncate on json payload dump
+payload_line_limit = 125  # number of lines to truncate on json payload dump
 headers = {"Content-Type": "application/json"}
 region_name = "us-east-1"
 KNOWN_SOLVENT_NAMES = {"DMSO normalization", "Water", "Buffer"}
diff --git a/tetrascience/ssp-tecan-to-mosaic/task-script/requirements.txt b/tetrascience/ssp-tecan-to-mosaic/task-script/requirements.txt
index c4a63d5..7729f30 100644
--- a/tetrascience/ssp-tecan-to-mosaic/task-script/requirements.txt
+++ b/tetrascience/ssp-tecan-to-mosaic/task-script/requirements.txt
@@ -17,6 +17,6 @@ python-dateutil==2.9.0.post0 ; python_version >= "3.10"
 s3transfer==0.13.1 ; python_version >= "3.10"
 six==1.17.0 ; python_version >= "3.10"
 sniffio==1.3.1 ; python_version >= "3.10"
-tenacity==9.1.2 ; python_version >= "3.10"
+tenacity>=8.5.0,<9.0.0 ; python_version >= "3.10"
```
