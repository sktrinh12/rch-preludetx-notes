[Home](../../main.md) | [Prev: Day 216](notes_2025-08-21.md) | [Next: Day 218](./notes_2025-08-25.md)

## 📝 Day 217, Friday - `notes_2025-08-22.md`

### US352
- New ADC Project planning
    * tested new sql on DEV; for specific tables in Bioregister browser project; there are about 4 separate tables with 4 individual DS's
    * ADC Batch Inventory section is empty for some strange reason; probably never used (it uses `ADC_INV_INFO`)

```sql
-- for ADC_BATCH_INFO
WITH t AS (
 select * from bioreg_ids_by_ab_target
)
SELECT *
FROM ADC_BATCH_INFO adc
WHERE parent_bioreg_id NOT IN (SELECT bioreg_id FROM t)
   OR EXISTS (
       SELECT 1
       FROM GATEWAY.PERSONNEL_ROLES pr
       WHERE pr.group_id = 481
         AND pr.isid = UPPER('-USER-')
   )
;


-- for ADC_CALC_PHY_PROPS
WITH t AS (
 select * from bioreg_ids_by_ab_target
)
SELECT *
FROM ADC_CALC_PHY_PROPS adc
WHERE bioreg_id NOT IN (SELECT bioreg_id FROM t)
   OR EXISTS (
       SELECT 1
       FROM GATEWAY.PERSONNEL_ROLES pr
       WHERE pr.group_id = 481
         AND pr.isid = UPPER('-USER-')
   )
;
```

- discovered that `ADC_INV_INFO` is completely empty in DEV and PROD; seems completely useless
- created `BIOREG_IDS_BY_AB_TARGET` on DEV to capture all bioreg_ids that are related to `CAL-R` ab targets; this way it is cleaner and easier to reference them in the CTE


### US341
- develop script to ingest tecan file and upload using mosaic api
    * re-ran the pipeline (`268823_01`) but did not create the mosaic plate due to missing PRT#s in UAT:

```
"PRT1013500-001"
"PRT1013514-001"
"PRT1013559-001"
"PRT1012406-003"
"PRT1013557-001"
"PRT1013560-001"
"PRT1013556-001"
"PRT1013513-001"
"PRT1013558-001"
```

- from `268805_01` the following don't exist:

```
"PRT1010099-002"
"PRT1013502-001"
```

- client deleted original `.csv` file and removed the `.json` IDS data from TDP UAT and re-uploaded a file for `268823_01` however, turned out it was a `.txt` file and didn't get uploaded as IDS data; thus had to re-process everything over again to get the data in TDP properly
    * end of day, it worked as expected, logs show each step in detail and data could be seen in mosaic UAT
    * next step is do trigger the pherastar pipeline for this dataset `268823_01`
    * after client properly injected valid PRT#'s that exist in UAT the `name` column of main sql query showed below which finally called the mosaic api with a valid substance json payload:

```
"PRT1007512-001"
"PRT1007529-001"
"PRT1007539-001"
"PRT1007528-001"
"PRT1007513-001"
"PRT1007530-001"
"DMSO normalization"
"PRT1007514-001"
"PRT1007516-001"
"PRT1007527-001"
```

#### Issue with 1000 magnitude difference in SU analysis tab

- From the docs:
>Titian base unit for MolarConcentration is mM (millimolar).

the number for value is interpreted as mM. so need to convert to uM by dividing by 1000 and setting displayExponent to -6

>Display Exponent
>The display exponent specifies the units that should be used when an amount is displayed. So for example, rather than displaying 0.0001 µL, it may be preferable to display this to the operator as 0.1 nL. This preference is recorded as the base 10 exponent representing the prefix to apply to the Prefix‑less Unit. For example:

>|DisplayExponent|	Display	Prefix| Examples|
>|---|---|---|
>|-9|	'n' for nano|	ng, nL, nM|
>|-6 | 'µ' for micro-	|µg, µL, µM|
>|-3 | 'm' for milli-	|mg, mL, mM|
>|0  | none	|g, L, M|
>|3  | 'k' for kilo-|	kg, kL, kM|

- command to replace json payload with correctly adjusted value numbers and displayExponent value

```bash
jq '.[].sampleHolders[].solutionSample.constituents[].concentration |=
      (.value = (.value / 1000) | .displayExponent = -6)' t.json | xclip -selection clipboard
```

- added logic to correct value unit and base for substance and solvent

```diff
-    volume_value = row.get("volume_dispensed_value") # e.g. 121.2 (nL) `volume_dispensed_value`
+    volume_value = row.get(
+        "volume_dispensed_value"
+    )  # e.g. 121.2 (nL) `volume_dispensed_value`
     volume_dispensed_unit = row.get("volume_dispensed_unit") or "uL"
-
+    conc_unit = row.get("concentration_unit") or "uM"
+    conc_value = row.get("concentration_value") or 0
+
+    if conc_unit.lower() in ["um", "µm"]:
+        value_mM = conc_value / 1000.0  # µM → mM
+        display_exp = -6
+    elif conc_unit.lower() == "nm":
+        value_mM = conc_value * 1e-6  # nM → mM
+        display_exp = -9
+    else:
+        value_mM = conc_value  # mosaic base unit in mM
+        display_exp = -3
+
+    display_exp_vol = -3
     if volume_dispensed_unit == "nL":
         volume_value /= 1000  # convert to uL
+        display_exp_vol = -9
 
     if not substance_data and name.strip() in KNOWN_SOLVENT_NAMES:
         return "pure_solvent", {
@@ -307,7 +325,6 @@ def build_sample_holder(row: dict, substance_data: dict):
         print(f"Skipping unknown substance in payload: {name}")
         return None
 
-
     # For substance wells
     sample_holder = {
         "position": {"x": row_number, "y": column_number},
@@ -316,13 +333,14 @@ def build_sample_holder(row: dict, substance_data: dict):
                 {
                     "substanceId": substance_data["substanceId"],
                     "concentration": {
-                        "value": row.get("concentration_value") or 0,
+                        "value": value_mM,
                         "unitType": 1,
+                        "displayExponent": display_exp,
                     },
                 }
             ],
             "solvents": [{"solventId": 0, "proportion": 1.0}],
-            "volume": {"value": volume_value},
+            "volume": {"value": volume_value, "displayExponent": display_exp_vol},
         },
```
