[Home](../../main.md) | [Prev: Day 219](notes_2025-08-26.md) | [Next: Day 221](./notes_2025-08-28.md)

## ðŸ“ Day 220, Wednesday - `notes_2025-08-27.md`

### US341
- develop script to ingest tecan file and upload using mosaic api
    * the tecan raw input csv file shows (`268823 2025-08-21 1158.csv`):

```
"",1,"C03",3,3,"C03",3,3,"PRT1007513-001",0.0999,,0.0999,,,,,,,,,100,100,,100,,,,,,,,,,100100.1001001,0.000999
```

* `C03` well in mosaic server shows 0.0999 uM
* the mosaic api shows: `"value": 9.99E-05,`
* ids data: `"value":0.0999, "unit":"uM"`
* unsure why user expects a different value in SU
* client mentioned can consider this user story closed since the work has been done; new US can be created to deploy on production



### US352
- New ADC Project planning
    * created CAL-R button in Bioregister on dev
    * this is an option; or if client wants an entirely new project button on home page? provide screenshots for feedback
    * these DSs need to be worked on: `ADC_TARGET_VW` and `ADC_BATCH_INFO` and `ADC_REG_INFO` and `ADC_INV_INFO` and `SUMM_ADC` and `BI_NUC_UPLOAD_FMT`
    * Caveats:
        * perhaps need to create at least 4 new DS; perhaps name them with `CALR` suffixes, but down road may change, then DS names will be inaccurate
        * need to add to project, so it can be visible in forms, this may complicate list of DS in views and exports
        * DS refreshes will increase, more mgmt
    * rather than creating new DSs may be able to utilise the dynamic DS; which still lives in the `Datasources` tab, however not part of the DS refresh schedule
    * sql for 3 valid DSs with CALR filters (data subsets):


```sql
-- ADC_TARGET_VW
WITH base_query AS (
    SELECT
        TO_DATE(TO_CHAR(parent.date_created, 'MM-DD-YYYY'), 'MM-DD-YYYY') AS registration_date,
        parent.bioreg_id AS parent_bioreg_id,
        child.bioreg_id,
        'PRT500' || SUBSTR(child.bioreg_id, 7, 4) AS formatted_tr,
        ab.value AS ab_target,
        payload.value AS payload_target
    FROM c2c.complex_child cc
    JOIN c2c.complex parent 
        ON parent.id = cc.complex_id
    JOIN c2c.complex_child cc2
        ON cc2.child_id = cc.child_id
    JOIN c2c.complex child
        ON child.id = cc2.child_id
       AND UPPER(child.composition) NOT LIKE '%DELETED%'
    LEFT JOIN (
        SELECT v.owner_id, v.value
        FROM c2c.string_value v
        WHERE v.type_id = 6
    ) ab ON parent.id = ab.owner_id
    LEFT JOIN (
        SELECT v.owner_id, v.value
        FROM c2c.string_value v
        WHERE v.type_id = 16
    ) payload ON cc.child_id = payload.owner_id
    LEFT JOIN c2c.complex e
        ON child.bioreg_id = e.bioreg_id
    WHERE ab.value = 'CAL-R'
)
SELECT *
FROM base_query


-- ADC_BATCH_INFO
SELECT
    a.batch_id,
    a.bioreg_id    AS parent_bioreg_id,
    o.value        AS experiment_id,
    e.value        AS monomeric_purity,
    l.value        AS endotoxin_level,
    g.value        AS dar_hic_hplc,
    h.value        AS dar_lcms,
    i.value        AS dar_uvvis,
    j.value        AS volume,
    k.value        AS conc,
    n.value        AS barcode,
    m.value        AS formulation_buffer,
	P.VALUE        AS Batch_MW,
	R.VALUE        AS Unconjugated_mab,
    T.VALUE		   AS DAR_nOBE_MS,
to_date(to_char(Batch_created_date,'MM-DD-YYYY'),'MM-DD-YYYY') as Batch_created_date,
to_date(to_char(Bioreg_id_created_date,'MM-DD-YYYY'),'MM-DD-YYYY') as Bioreg_id_created_date,
to_date(to_char(Updated_batch_date,'MM-DD-YYYY'),'MM-DD-YYYY') as Updated_batch_date
FROM
    (
        
        SELECT
            c.id           AS protein_sample_id,
            a.complex_id,
            b.date_created as Bioreg_id_created_date, 
			c.date_created as Batch_created_date,
            b.id,
            b.bioreg_id,
            a.child_id,
            c.bioreg_id    AS batch_id,
            c.last_updated as Updated_batch_date
        FROM
                 c2c.complex_child a
            JOIN c2c.complex           b ON b.id = a.child_id
            JOIN (SELECT * FROM c2c.protein_sample WHERE DELETED=0)      c ON c.complex_id = b.id
        WHERE UPPER(b.composition) NOT LIKE '%DELETED%'
    )  a
    JOIN (
        SELECT v.owner_id, v.value
        FROM   c2c.string_value v
        WHERE  v.type_id = 6
          AND  v.value = 'CAL-R'
    ) ab
    ON a.complex_id = ab.owner_id
    LEFT JOIN (
        SELECT
            b.value,
            b.owner_id
        FROM
                 c2c.float_value_type a
            JOIN c2c.float_value b ON a.id = b.type_id
        WHERE
            type_id = 12
    )  e ON a.protein_sample_id = e.owner_id
    LEFT JOIN
	 (SELECT A.NAME,
            b.value,
            b.owner_id
        FROM
                 c2c.float_value_type a
            JOIN c2c.float_value b ON a.id = b.type_id
        WHERE
            type_id = 17) t ON a.protein_sample_id = t.owner_id
    LEFT JOIN (
        SELECT
            b.value,
            b.owner_id
        FROM
                 c2c.float_value_type a
            JOIN c2c.float_value b ON a.id = b.type_id
        WHERE
            type_id = 10
    )  g ON a.protein_sample_id = g.owner_id
    LEFT JOIN (
        SELECT
            b.value,
            b.owner_id
        FROM
                 c2c.float_value_type a
            JOIN c2c.float_value b ON a.id = b.type_id
        WHERE
            type_id = 11
    )  h ON a.protein_sample_id = h.owner_id
    LEFT JOIN (
        SELECT
            b.value,
            b.owner_id
        FROM
                 c2c.float_value_type a
            JOIN c2c.float_value b ON a.id = b.type_id
        WHERE
            type_id = 13
    )  i ON a.protein_sample_id = i.owner_id
    LEFT JOIN (
        SELECT
            b.value,
            b.owner_id
        FROM
                 c2c.float_value_type a
            JOIN c2c.float_value b ON a.id = b.type_id
        WHERE
            type_id = 8
    )  j ON a.protein_sample_id = j.owner_id
    LEFT JOIN (
        SELECT
            b.value,
            b.owner_id
        FROM
                 c2c.float_value_type a
            JOIN c2c.float_value b ON a.id = b.type_id
        WHERE
            type_id = 7
    )  k ON a.protein_sample_id = k.owner_id
    LEFT JOIN (
        SELECT
            b.value,
            b.owner_id
        FROM
                 c2c.float_value_type a
            JOIN c2c.float_value b ON a.id = b.type_id
        WHERE

            type_id = 14
    )  l ON a.protein_sample_id = l.owner_id
	
	LEFT JOIN (SELECT a.name,
            b.value,
            b.owner_id
        FROM
                 c2c.float_value_type a
            JOIN c2c.float_value b ON a.id = b.type_id
        WHERE
            type_id = 9) P ON A.protein_sample_id=P.OWNER_ID
	LEFT JOIN (SELECT a.name,
            b.value,
            b.owner_id
        FROM
                 c2c.float_value_type a
            JOIN c2c.float_value b ON a.id = b.type_id
        WHERE
            type_id = 16) R ON A.protein_sample_id=R.OWNER_ID
	
    LEFT JOIN (
        SELECT
            a.id,
            a.name,
            b.value,
            b.owner_id
        FROM
                 c2c.string_value_type a
            JOIN c2c.string_value b ON a.id = b.type_id
        WHERE
            b.type_id = 19
    )  m ON a.protein_sample_id = m.owner_id
    LEFT JOIN (
        SELECT
            a.id,
            a.name,
            b.value,
            b.owner_id
        FROM
                 c2c.string_value_type a
            JOIN c2c.string_value b ON a.id = b.type_id
        WHERE
            b.type_id = 14
    )  n ON a.protein_sample_id = n.owner_id
    LEFT JOIN (
        SELECT
            a.id,
            a.name,
            b.value,
            b.owner_id
        FROM
                 c2c.string_value_type a
            JOIN c2c.string_value b ON a.id = b.type_id
        WHERE
            b.type_id = 17
    )  o ON a.protein_sample_id = o.owner_id

-- ADC_REG_INFO
SELECT
    b.bioreg_id,
    g.formatted_id        AS payload_linker,
    b.extinction_coeff    AS ext_coeff,
    b.molecular_weight    AS mw,
    b.pi,
    f.value               AS payload,
 CASE
        WHEN a.Antibody_name IS NOT NULL THEN
            a.Antibody_name
        ELSE
            'None Provided'
    END                   AS Antibody_name,
    CASE
        WHEN b.name IS NOT NULL THEN
            b.name
        ELSE
            'None Provided'
    END                   AS name,
    c.value               AS ab_target,
    d.value               AS payload_target
FROM
         (
        SELECT
            b.date_created,
            b.id,
            b.bioreg_id,
            a.child_id,
			b.name as Antibody_name
        FROM
                 c2c.complex_child a
            JOIN c2c.complex b ON b.id = a.complex_id
    ) a
    JOIN (
        SELECT
            *
        FROM
                 c2c.complex_child a
            JOIN c2c.complex b ON b.id = a.child_id
        WHERE
            upper(composition) NOT LIKE '%DELETED%'
    )  b ON b.child_id = a.child_id
    JOIN (
        SELECT
            a.id,
            a.name,
            b.value,
            b.owner_id
        FROM
                 c2c.string_value_type a
            JOIN c2c.string_value b ON a.id = b.type_id
        WHERE
            b.type_id = 6
            AND  b.value = 'CAL-R'
    )  c ON a.id = c.owner_id
    LEFT JOIN (
        SELECT
            a.id,
            a.name,
            b.value,
            b.owner_id
        FROM
                 c2c.string_value_type a
            JOIN c2c.string_value b ON a.id = b.type_id
        WHERE
            b.type_id = 15
    )  f ON a.child_id = f.owner_id
    LEFT JOIN (
        SELECT
            a.id,
            a.name,
            b.value,
            b.owner_id
        FROM
                 c2c.string_value_type a
            JOIN c2c.string_value b ON a.id = b.type_id
        WHERE
            b.type_id = 16
    )  d ON a.child_id = d.owner_id
    LEFT JOIN (
        SELECT
            bioreg_id,
            b.smiles,
            b.formatted_id
        FROM
                 ds3_userdata.adc_conjugate_vw a
            JOIN c$pinpoint.reg_data b ON a.formatted_id = b.formatted_id
    )  g ON g.bioreg_id = b.bioreg_id
```

- instead created dyanmic DSs for all of above so that they are not part of the DS refresh schedule and only get run on query run-time
    * each one will query on the original sql but with calr filters

```sql
-- ADC_TARGET_VW
select * from ADC_TARGET_ORG_VW
where ab_target = 'CAL-R'

-- ADC_BATCH_CALR_INFO
WITH t AS (
 select distinct bioreg_id from bioreg_ids_by_ab_target
)
SELECT *
FROM ADC_BATCH_INFO adc
WHERE parent_bioreg_id IN (SELECT bioreg_id FROM t)


-- ADC_REG_CALR_INFO
WITH t AS (
 select distinct bioreg_id from bioreg_ids_by_ab_target
)
select * from ADC_REG_INFO adc
WHERE bioreg_id IN (SELECT bioreg_id FROM t)
```

- created `Query Tempalte` for SSS molecular search: `Payload_Linker_CALR`

```sql
SELECT bioreg_id
  FROM
    (SELECT
       a.bioreg_id,
       b.smiles
     FROM ds3_userdata.adc_conjugate_vw a
     JOIN c$pinpoint.reg_data b ON a.formatted_id=b.formatted_id
     JOIN bioreg_ids_by_ab_target c ON a.bioreg_id = c.bioreg_id)
where -SEARCHTERMS-(smiles, '-STRUCT-|mdl')-OPS-
```

>Chemical Structures
>SQL
>e.g.: select compound_id from ds3_userdata.chemistry_structures where -SEARCHTERMS-(smiles, '-STRUCT-')-OPS-

>-SEARCHTERMS- will be replaced by the cartridge SSS, SIM or EXACT statement

>-STRUCT- will be replaced by a smiles string or molfile, and -OPS- will be replaced by the condition (e.g. =1).

>-USER- will be replaced by the current isid.

>-MOLBINDSTRUCT- will be replaced by a ? and a bind variable added with the smiles, chime or molfile.

>-MOLBIND- (normally used with remote connections) will be replaced by a ? and a bind variable added with the smiles, chime or molfile.

>-MOD- an advanced option to use with search modulators/switches, eg |mdl.

>-SIMSCORE- will insert the sql to return the similarity score.

>-SEPARATOR- is used to separate mutiple statements.

- set tool = `Dotmatics Elemental`, cartridge = `PINPOINT`
