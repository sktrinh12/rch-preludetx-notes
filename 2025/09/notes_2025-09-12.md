[Home](../../main.md) | [Prev: Day 230](notes_2025-09-11.md) | [Next: Day 232](./notes_2025-09-15.md)

## 📝 Day 231, Friday - `notes_2025-09-12.md`


### US367
- add additional features for mass-spec jupyter notebook tool
    * created windows server 2022 base AMI on ec2 (in order to install GraphPad Prism):
        * use of `strinh` key-pair
        * use of public subnet that has IGW
- RDP connection to Windows instance failing with timeout errors
    * `telnet` to port 3389 hanging/timing out
    * Same issue occurred with both Windows Server 2025 and 2022 AMIs
    * **Instance was launched in a private subnet** (`subnet-074002489fcb3cf3b`) associated with the **rch-private-route** table, which had no Internet Gateway route
- steps taken:
    1. **Security Groups were correct** - ruled out firewall issues
    2. **Telnet from AWS CloudShell also failed** - confirmed it wasn't local network/ISP blocking
    3. **Ping from CloudShell hung** - indicated network routing problem
    4. **Route table investigation revealed**:
       - `rch-private-route`: 6 subnets, **No Internet Gateway**
       - `rch-public-route`: 2 subnets, **Yes Internet Gateway**
    5. **Instance's subnet was associated with private route table**
- Launch new instances in **public subnets** associated with `rch-public-route` route table.
    * rch-public-route: `rtb-0ef179c21f5136dd4`
    * public subnet could be 1 of 2: 
        * `rch-1b-dmz2`: `subnet-074002489fcb3cf3b`
        * `rch-1a-dmz1` : `subnet-06b662fd5609083cb`
    * Network connectivity issues often appear as application-level problems (RDP not working), but the root cause was infrastructure-level (no internet routing)
- next steps were then to install latest version of webview2 for microsoft edge; then when downloaded the `prism10.msi` file, able to launch successfully and it prompted for validating with token purchased or just viewer; clicked this last option to just view files
    * from aws UI console; upload the `strinh.pem` file to get the windows generated password; then download the `.rdp` file by clicking on the `Connect` button within the instance details
        * update the `.rdp` file with a new `password:s:` entry
    * use of `xfreerdp` cmd line tool
    * mount local drive to share files, `/drive:ubuntu`
    * remove the `/f` flag which is full screen mode (more difficult to multi-task between ubuntu and windows)

```bash
xfreerdp /v:$(grep '^full address' ~/Downloads/preludetx-prism-windows.rdp | cut -d':' -f3) \
        /u:$(grep '^username' ~/Downloads/preludetx-prism-windows.rdp | cut -d':' -f3) \
        /p:$(grep '^password' ~/Downloads/preludetx-prism-windows.rdp | cut -d':' -f3) \
        /clipboard \
        /drive:ubuntu,/home/spencer-trinh/Documents/rch-preludetx/scripts/notebooks/output_files
```

#### aws cli ec2 command

```bash
aws ec2 run-instances --image-id "ami-028dc1123403bd543" --instance-type "t3.micro" --key-name "strinh" --block-device-mappings '{"DeviceName":"/dev/sda1","Ebs":{"Encrypted":true,"DeleteOnTermination":true,"KmsKeyId":"arn:aws:kms:us-east-1:581351078906:key/2ec60e5b-730e-4f97-8f73-a35dda160929","SnapshotId":"snap-043e541b3f6be8b9d","VolumeSize":30,"VolumeType":"gp2"}}' --network-interfaces '{"SubnetId":"subnet-06b662fd5609083cb","AssociatePublicIpAddress":true,"DeviceIndex":0,"Groups":["sg-09f682ebd7007a345"]}' --credit-specification '{"CpuCredits":"unlimited"}' --tag-specifications '{"ResourceType":"instance","Tags":[{"Key":"Name","Value":"preludetx-prism-windows"}]}' --private-dns-name-options '{"HostnameType":"ip-name","EnableResourceNameDnsARecord":false,"EnableResourceNameDnsAAAARecord":false}' --count "1" --profile rchsandbox
```

- however this can't be run since no access key or secret key for aws
    * need to use `turbot` cli, but IT would have to provide these sensitive data
    * so atm just use the UI
- link to download prism: `https://www.graphpad.com/updates`

---

- Isaac from RCH provided commands to get turbot to generate the proper aws credentials to use in aws cli commands:
    * first go into turbot and go to Accounts and click `Access keys` then click `Create Access key` and within terminal enter `turbot configure` to prompt for configuration: enter the workspace url from turbot UI and the two keys provided
        * the workspace url can be copied from `Developers` tab under the `prerequisites` panel: `https://turbot-rchsolutions.cloud.turbot.com`
    * then run this in terminal to generate a temporary aws credential `turbot aws credentials --account 581351078906 --level superuser --aws-profile rchsandbox --profile rch`

#### Running aws cli commands using the rch profile created from turbot:

```bash
aws ec2 describe-instances --query "Reservations[*].Instances[*].[InstanceId,State.Name,Tags[?Key=='Name'].Value|[0]]" --output table --profile rchsandbox
 aws ec2 terminate-instances --instance-ids i-06efcdfcb98ccd53d --profile rchsandbox
```

### US369
- validate ms tool using the excel file as ref
    * Input files: `*.backup` (tab-delimited)
    * Each file has 12 numeric columns
    * Required transformation:
      * Swap **columns 3, 4, 5** with **columns 10, 11, 12**
      * Shift the other columns left, keeping order

- desired column order due to incorrect sorting from client in the original `.xlsx` file:
```
1  2  6  7  8  9  10  11  12  3  4  5
```

---

- batch processing all `.backup` files:
    * To apply the transformation to all `.backup` files in the folder:
    * `$1` is the index (sample peak name)

```bash
for f in *.backup; do
    awk '{print $1, $2, $6, $7, $8, $9, $10, $11, $12, $13, $3, $4, $5}' OFS='\t' "$f" > "${f%.backup}"
done
```

* `${f%.backup}` → strips the `.backup` extension for the output file
* Input: `4130_1.backup` → Output: `4130_1`
* Input: `2857_2.backup` → Output: `2857_2`


---


#### Summary of Steps to Compare calculted values from `frac_df` with copied values (excel)

- **Prepare output `.out` files:**
    - Original data was copied from Excel and saved as `.backup`.
    - Used a Unix command (`awk`) to swap columns 3–5 to the end and output as `.out` files for processing.

- **Read excel values as files in Python:**
    - Loaded all `.out` files from `input_dir` using `pandas.read_csv()`.

- **Select matching columns from `frac_df`:**
    - Extracted compound and replicate identifiers from filenames (e.g., `2141_1`) to select relevant columns.

- **Sort columns numerically:**
    - Implemented a `sort_key` to sort columns by compound, replicate, and numeric suffix (e.g., `4430_1_1, 4430_1_2, ...`) to match excel values.

- **Align `.out` columns with `frac_df`:**
    - Ensured subtraction occurs column-wise in the correct order.

- **Compute differences:**
    - Subtracted `backup_df` values from `frac_df` values after alignment.
    - Calculated overall standard deviation of differences for each compound/replicate. `nan` outputted for `nan` columns.

- **Render results in Jupyter Notebook:**
    - Converted difference matrices to `pandas.DataFrame`.
    - Ensured both DataFrames have **columns in the same sorted order**.
